---
import BaseLayout from "../layouts/BaseLayout.astro";
import Sidebar from "../components/Sidebar.astro";
import BottomNav from "../components/BottomNav.astro";
import { ogImageServiceUrl } from "../config/constants";

const searchUrl = new URL("/search", Astro.site || "https://miguelmachado.dev")
  .href;
const searchOgImage = `${ogImageServiceUrl}?title=${encodeURIComponent("Buscar Posts - Miguel Machado")}&url=${searchUrl}`;
---

<BaseLayout
  title="Buscar Posts - Miguel Machado"
  description="Busque por artigos sobre desenvolvimento web moderno, Golang, TypeScript, React, arquitetura de software, performance e boas práticas de engenharia. Conteúdo técnico especializado para desenvolvedores."
  ogImage={searchOgImage}
  canonical={searchUrl}
>
  <div class="app-container" data-pagefind-ignore="all">
    <Sidebar />

    <main class="main-content">
      <div class="content-wrapper">
        <div class="search-container">
          <h1 class="search-title">Buscar Posts</h1>
          <div id="search"></div>
        </div>
      </div>

      <BottomNav activePage="search" />
    </main>
  </div>

  <link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
  <script is:inline src="/pagefind/pagefind-ui.js"></script>

  <script>
    // @ts-expect-error - Pagefind UI is loaded via script tag
    import { PagefindUI } from "@pagefind/default-ui";

    function initializeSearch() {
      const searchElement = document.querySelector("#search");
      if (!searchElement) return;

      // Clear previous instance if exists
      searchElement.innerHTML = "";

      new PagefindUI({
        element: "#search",
        showSubResults: true,
        autofocus: true,
      });

      const el = document.querySelector(".pagefind-ui");
      const input = el?.querySelector<HTMLInputElement>(`input[type="text"]`);
      const clearButton = el?.querySelector(".pagefind-ui__search-clear");

      // Check if the current URL has any query params
      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      const query = params.get("q");

      // If query exists on page load
      if (query && input) {
        input.value = query;
        input.dispatchEvent(new Event("input", { bubbles: true }));
      }

      input?.addEventListener("input", (e) => {
        const input = e.target as HTMLInputElement;
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        params.set("q", input.value);
        window.history.replaceState({}, "", `${url.pathname}?${params}`);
      });

      clearButton?.addEventListener("click", () => {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        params.delete("q");
        window.history.replaceState({}, "", `${url.pathname}`);
      });
    }

    // Initialize on first load
    document.addEventListener("DOMContentLoaded", initializeSearch);

    // Re-initialize on view transitions
    document.addEventListener("astro:page-load", initializeSearch);
  </script>
</BaseLayout>

<style>
  .app-container {
    display: flex;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .main-content {
    flex: 1;
    margin-left: 280px;
    padding: 2rem;
    padding-bottom: 5rem;
    width: calc(100% - 280px);
    max-width: 100vw;
    box-sizing: border-box;
  }

  .content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }

  .search-container {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
    backdrop-filter: blur(10px);
    width: 100%;
    box-sizing: border-box;
  }

  .search-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: var(--text-primary);
  }

  /* Custom Pagefind UI styling to match your theme */
  :global(.pagefind-ui) {
    width: 100% !important;
  }

  :global(.pagefind-ui__form) {
    position: relative !important;
    display: block !important;
  }

  :global(.pagefind-ui__form:before) {
    display: none !important;
  }

  :global(.pagefind-ui__search-input) {
    background-color: var(--bg-secondary) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    color: var(--text-primary) !important;
    padding: 0.875rem 3.5rem 0.875rem 1rem !important;
    font-size: 1rem !important;
    width: 100% !important;
    transition: all 0.2s ease !important;
  }

  :global(.pagefind-ui__search-input:focus) {
    border-color: var(--accent-purple) !important;
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(162, 119, 255, 0.1) !important;
  }

  :global(.pagefind-ui__search-input::placeholder) {
    color: var(--text-secondary) !important;
    opacity: 0.6 !important;
  }

  /* Clear button styling - FIXED positioning */
  :global(.pagefind-ui__search-clear) {
    all: initial !important;
    font-family: inherit !important;
    position: absolute !important;
    right: 0.75rem !important;
    top: 25px !important;
    transform: translateY(-50%) !important;
    background: var(--bg-secondary) !important;
    color: var(--text-secondary) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 6px !important;
    padding: 0.4rem 0.65rem !important;
    font-size: 0.8125rem !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    height: auto !important;
    width: auto !important;
    z-index: 10 !important;
    display: inline-block !important;
    box-sizing: border-box !important;
    line-height: 1 !important;
    margin: 0 !important;
    text-align: center !important;
  }

  :global(.pagefind-ui__search-clear:hover) {
    background: var(--accent-purple) !important;
    color: var(--bg-primary) !important;
    border-color: var(--accent-purple) !important;
  }

  /* Drawer - ensure it doesn't interfere */
  :global(.pagefind-ui__drawer) {
    display: flex !important;
    flex-direction: column !important;
    gap: 0 !important;
    margin-top: 2rem !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  /* Results area */
  :global(.pagefind-ui__results-area) {
    margin-top: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Individual result styling - CONSISTENT SIZING */
  :global(.pagefind-ui__result) {
    background-color: var(--bg-secondary) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 12px !important;
    padding: 1.5rem !important;
    margin-bottom: 1rem !important;
    overflow: hidden !important;
    transition: all 0.2s ease !important;
    display: block !important;
    list-style: none !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  :global(.pagefind-ui__result:hover) {
    border-color: var(--accent-purple) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 24px rgba(162, 119, 255, 0.15) !important;
  }

  /* Remove thumbnail/image area */
  :global(.pagefind-ui__result-thumb) {
    display: none !important;
  }

  /* Result inner container */
  :global(.pagefind-ui__result-inner) {
    padding: 0 !important;
    display: block !important;
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  /* Main result title - larger and consistent */
  :global(.pagefind-ui__result-inner > .pagefind-ui__result-title) {
    color: var(--text-primary) !important;
    font-weight: 600 !important;
    font-size: 1.125rem !important;
    line-height: 1.5 !important;
    margin-bottom: 0.5rem !important;
  }

  :global(.pagefind-ui__result-link) {
    text-decoration: none !important;
    color: var(--text-primary) !important;
    transition: color 0.2s ease !important;
    display: inline !important;
  }

  :global(.pagefind-ui__result-link:hover) {
    color: var(--accent-purple) !important;
  }

  :global(.pagefind-ui__result-excerpt) {
    color: var(--text-secondary) !important;
    margin-top: 0.5rem !important;
    line-height: 1.6 !important;
    font-size: 0.9rem !important;
  }

  /* Nested results (subsections) - consistent styling */
  :global(.pagefind-ui__result-nested) {
    margin-top: 1rem !important;
    padding-top: 1rem !important;
    border-top: 1px solid rgba(42, 42, 60, 0.5) !important;
  }

  :global(.pagefind-ui__result-nested:first-of-type) {
    margin-top: 1rem !important;
  }

  /* Nested result titles - smaller than main title */
  :global(.pagefind-ui__result-nested .pagefind-ui__result-title) {
    font-size: 0.95rem !important;
    font-weight: 500 !important;
    margin-bottom: 0.375rem !important;
    color: var(--text-secondary) !important;
  }

  :global(.pagefind-ui__result-nested .pagefind-ui__result-link) {
    color: var(--text-secondary) !important;
  }

  :global(.pagefind-ui__result-nested .pagefind-ui__result-link:hover) {
    color: var(--accent-purple) !important;
  }

  :global(.pagefind-ui__result-nested .pagefind-ui__result-excerpt) {
    font-size: 0.875rem !important;
    margin-top: 0.25rem !important;
  }

  /* Message styling */
  :global(.pagefind-ui__message) {
    color: var(--text-secondary) !important;
    padding: 1.5rem !important;
    text-align: center !important;
    background: transparent !important;
    border: none !important;
    border-radius: 0 !important;
    margin: 0 0 1.5rem 0 !important;
    font-size: 0.9rem !important;
  }

  /* Results list */
  :global(.pagefind-ui__results) {
    list-style: none !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Results area */
  :global(.pagefind-ui__results-area) {
    margin-top: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }

  /* Highlighted text in search results */
  :global(.pagefind-ui__result-excerpt mark),
  :global(.pagefind-ui__result-title mark) {
    background-color: var(--accent-purple) !important;
    color: var(--bg-primary) !important;
    padding: 0.15rem 0.3rem !important;
    border-radius: 4px !important;
    font-weight: 600 !important;
  }

  /* Loading state / Load more button */
  :global(.pagefind-ui__button) {
    all: unset !important;
    display: inline-block !important;
    background: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    padding: 0.875rem 1.75rem !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    font-size: 0.9rem !important;
    font-weight: 500 !important;
    text-align: center !important;
    margin: 1rem auto !important;
    box-sizing: border-box !important;
  }

  :global(.pagefind-ui__button:hover) {
    background: var(--accent-purple) !important;
    border-color: var(--accent-purple) !important;
    color: var(--bg-primary) !important;
    transform: translateY(-1px) !important;
  }

  @media (max-width: 768px) {
    .app-container {
      flex-direction: column;
      overflow-x: hidden;
    }

    .main-content {
      margin-left: 0;
      padding: 1rem;
      padding-bottom: 6rem;
      width: 100%;
      max-width: 100vw;
    }

    .content-wrapper {
      width: 100%;
      padding: 0;
    }

    .search-container {
      padding: 1rem;
      width: 100%;
    }

    .search-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* Improve search input on mobile */
    :global(.pagefind-ui__search-input) {
      font-size: 0.9375rem !important;
      padding: 0.75rem 3rem 0.75rem 0.875rem !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    /* Adjust clear button position for mobile */
    :global(.pagefind-ui__search-clear) {
      right: 0.5rem !important;
      font-size: 0.75rem !important;
    }

    /* Make results more compact on mobile */
    :global(.pagefind-ui__result) {
      padding: 1rem !important;
      margin-bottom: 0.875rem !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    :global(.pagefind-ui__result-inner > .pagefind-ui__result-title) {
      font-size: 1rem !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }

    :global(.pagefind-ui__result-excerpt) {
      font-size: 0.875rem !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }

    :global(.pagefind-ui__result-nested) {
      margin-top: 0.75rem !important;
      padding-top: 0.75rem !important;
    }

    :global(.pagefind-ui__result-nested .pagefind-ui__result-title) {
      font-size: 0.875rem !important;
    }

    :global(.pagefind-ui__result-nested .pagefind-ui__result-excerpt) {
      font-size: 0.8125rem !important;
    }

    :global(.pagefind-ui__drawer) {
      margin-top: 1.5rem !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    :global(.pagefind-ui__results) {
      width: 100% !important;
    }
  }

  @media (max-width: 480px) {
    .app-container {
      min-height: 100vh;
      display: block;
    }

    .main-content {
      padding: 0.75rem;
      width: 100%;
    }

    .content-wrapper {
      width: 100%;
    }

    .search-container {
      padding: 0.875rem;
      border-radius: 8px;
      width: 100%;
    }

    .search-title {
      font-size: 1.25rem;
      margin-bottom: 1.25rem;
      word-wrap: break-word;
    }

    /* Further optimize for very small screens */
    :global(.pagefind-ui__search-input) {
      font-size: 0.875rem !important;
      padding: 0.625rem 2.75rem 0.625rem 0.75rem !important;
    }

    :global(.pagefind-ui__search-clear) {
      right: 0.375rem !important;
      font-size: 0.6875rem !important;
    }

    :global(.pagefind-ui__result) {
      padding: 0.875rem !important;
      border-radius: 8px !important;
    }

    :global(.pagefind-ui__result-inner > .pagefind-ui__result-title) {
      font-size: 0.9375rem !important;
      line-height: 1.4 !important;
    }

    :global(.pagefind-ui__result-excerpt) {
      font-size: 0.8125rem !important;
      line-height: 1.5 !important;
    }

    :global(.pagefind-ui__message) {
      padding: 1rem !important;
      font-size: 0.875rem !important;
    }

    :global(.pagefind-ui__button) {
      padding: 0.75rem 1.5rem !important;
      font-size: 0.875rem !important;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
  }
</style>
