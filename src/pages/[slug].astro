---
import BaseLayout from "../layouts/BaseLayout.astro";
import Sidebar from "../components/Sidebar.astro";
import BottomNav from "../components/BottomNav.astro";
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import { ogImageServiceUrl } from "../config/constants";
import { getTranslations, formatDate } from "../i18n";
import { getTranslationSlug, getPostSlug, getPostUrl } from "../lib/posts";

const lang = "pt";
const t = getTranslations(lang);

export async function getStaticPaths() {
  const blogEntries = await getCollection("blogPt");
  const sortedEntries = blogEntries
    .filter((entry) => !entry.data.draft)
    .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

  return sortedEntries.map((entry, index) => {
    const prevPost =
      index < sortedEntries.length - 1 ? sortedEntries[index + 1] : null;
    const nextPost = index > 0 ? sortedEntries[index - 1] : null;
    const slug = entry.data.slug || entry.id.replace(/\.md$/, "");

    return {
      params: { slug },
      props: { entry, prevPost, nextPost },
    };
  });
}

const { entry, prevPost, nextPost } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(entry);

const translationSlug = await getTranslationSlug(entry.id, "en");

const slug = entry.data.slug || entry.id.replace(/\.md$/, "");
const postUrl = new URL(`/${slug}`, Astro.site || "https://miguelmachado.dev")
  .href;
const ogImageUrl = `${ogImageServiceUrl}?title=${encodeURIComponent(entry.data.title)}&url=${postUrl}`;
---

<BaseLayout
  title={`${entry.data.title} - Miguel Machado`}
  description={entry.data.description}
  ogType="article"
  ogImage={ogImageUrl}
  articleDate={entry.data.pubDate}
  articleTags={entry.data.tags}
  canonical={postUrl}
  lang={lang}
  alternateSlug={translationSlug}
>
  <div class="app-container">
    <Sidebar translationSlug={translationSlug} />

    <main class="main-content">
      <div class="content-wrapper">
        <article class="post-article">
          <!-- Back Link -->
          <a href="/" class="back-link" data-pagefind-ignore>
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <path d="M19 12H5M12 19l-7-7 7-7"></path>
            </svg>
            <span>{t.blog.backToHome}</span>
          </a>

          <!-- Article Header -->
          <header class="post-header">
            <div class="post-meta" data-pagefind-ignore>
              <time datetime={entry.data.pubDate.toISOString()} class="post-date">
                {formatDate(entry.data.pubDate, lang)}
              </time>
              <span class="meta-separator"></span>
              <span class="reading-time">{remarkPluginFrontmatter.minutesRead}</span>
            </div>

            <h1 class="post-title" data-pagefind-meta="title">
              {entry.data.title}
            </h1>

            <p class="post-description">{entry.data.description}</p>

            {
              entry.data.tags && entry.data.tags.length > 0 && (
                <div class="post-tags" data-pagefind-ignore>
                  {entry.data.tags.map((tag) => (
                    <span class="tag">#{tag}</span>
                  ))}
                </div>
              )
            }
          </header>

          <!-- Featured Image -->
          {
            entry.data.image && (
              <div class="post-image" data-pagefind-ignore>
                {typeof entry.data.image === "object" &&
                "src" in entry.data.image ? (
                  <Image
                    src={entry.data.image}
                    alt={entry.data.title}
                    loading="eager"
                    fetchpriority="high"
                    quality={90}
                  />
                ) : typeof entry.data.image === "object" &&
                  "url" in entry.data.image ? (
                  <img
                    src={entry.data.image.url}
                    alt={entry.data.image.alt}
                    fetchpriority="high"
                  />
                ) : null}
              </div>
            )
          }

          <!-- Article Content -->
          <div class="post-content prose" data-pagefind-body>
            <Content />
          </div>

          <!-- Post Navigation -->
          {
            (prevPost || nextPost) && (
              <nav class="post-navigation" data-pagefind-ignore>
                <h3 class="nav-heading">Continue lendo</h3>
                <div class="nav-grid">
                  {prevPost && (
                    <a
                      href={`/${prevPost.data.slug || prevPost.id.replace(/\.md$/, "")}`}
                      class="nav-card prev"
                    >
                      <span class="nav-direction">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <path d="M19 12H5M12 19l-7-7 7-7" />
                        </svg>
                        {t.blog.previousPost}
                      </span>
                      <span class="nav-title">{prevPost.data.title}</span>
                    </a>
                  )}
                  {nextPost && (
                    <a
                      href={`/${nextPost.data.slug || nextPost.id.replace(/\.md$/, "")}`}
                      class="nav-card next"
                    >
                      <span class="nav-direction">
                        {t.blog.nextPost}
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <path d="M5 12h14M12 5l7 7-7 7" />
                        </svg>
                      </span>
                      <span class="nav-title">{nextPost.data.title}</span>
                    </a>
                  )}
                </div>
              </nav>
            )
          }
        </article>
      </div>

      <BottomNav activePage="post" translationSlug={translationSlug} />
    </main>
  </div>
</BaseLayout>

<style>
  .app-container {
    display: flex;
    min-height: 100vh;
  }

  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: var(--space-2xl);
    padding-bottom: var(--space-4xl);
    background: var(--bg-primary);
  }

  .content-wrapper {
    max-width: var(--content-max-width);
    margin: 0 auto;
  }

  .post-article {
    background-color: var(--bg-card);
    border-radius: var(--radius-2xl);
    padding: var(--space-3xl);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--border-light);
  }

  /* Back Link */
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    color: var(--text-tertiary);
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: var(--space-2xl);
    transition: all var(--transition-fast);
  }

  .back-link:hover {
    color: var(--accent-primary);
  }

  .back-link svg {
    transition: transform var(--transition-fast);
  }

  .back-link:hover svg {
    transform: translateX(-4px);
  }

  /* Post Header */
  .post-header {
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-2xl);
    border-bottom: 1px solid var(--border-light);
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    font-size: 0.875rem;
  }

  .post-date {
    color: var(--accent-primary);
    font-weight: 500;
  }

  .meta-separator {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--border-medium);
  }

  .reading-time {
    color: var(--text-muted);
  }

  .post-title {
    font-family: var(--font-display);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 600;
    color: var(--accent-primary);
    margin-bottom: var(--space-lg);
    line-height: 1.2;
    letter-spacing: -0.02em;
    text-shadow: 3px 3px 0 var(--accent-primary-light);
  }

  .post-description {
    font-size: 1.125rem;
    color: var(--text-secondary);
    line-height: 1.7;
    margin-bottom: var(--space-lg);
  }

  .post-tags {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }

  .tag {
    color: var(--text-tertiary);
    font-size: 0.8125rem;
    font-weight: 500;
    transition: color var(--transition-fast);
  }

  .tag:hover {
    color: var(--accent-primary);
  }

  /* Post Image */
  .post-image {
    margin: var(--space-2xl) calc(var(--space-xl) * -1);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .post-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Post Content - Prose Styles */
  .post-content {
    color: var(--text-primary);
  }

  .prose :global(h1),
  .prose :global(h2),
  .prose :global(h3),
  .prose :global(h4) {
    font-family: var(--font-display);
    font-weight: 500;
    color: var(--text-primary);
    margin-top: var(--space-2xl);
    margin-bottom: var(--space-md);
    line-height: 1.3;
    letter-spacing: -0.02em;
  }

  .prose :global(h2) {
    font-size: 1.625rem;
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--border-light);
  }

  .prose :global(h3) {
    font-size: 1.375rem;
  }

  .prose :global(h4) {
    font-size: 1.125rem;
  }

  .prose :global(p) {
    margin-bottom: var(--space-lg);
    line-height: 1.85;
    color: var(--text-secondary);
    font-size: 1.0625rem;
  }

  .prose :global(a) {
    color: var(--accent-primary);
    text-decoration: underline;
    text-decoration-color: var(--accent-primary-light);
    text-underline-offset: 3px;
    transition: all var(--transition-fast);
  }

  .prose :global(a:hover) {
    color: var(--accent-primary-hover);
    text-decoration-color: var(--accent-primary);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--space-lg);
    padding-left: var(--space-xl);
    color: var(--text-secondary);
  }

  .prose :global(li) {
    margin-bottom: var(--space-sm);
    line-height: 1.8;
  }

  .prose :global(li::marker) {
    color: var(--accent-primary);
  }

  .prose :global(strong) {
    color: var(--text-primary);
    font-weight: 600;
  }

  .prose :global(code) {
    background: var(--bg-tertiary);
    color: var(--accent-primary);
    padding: 0.2rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.9em;
    font-family: var(--font-mono);
    font-weight: 500;
  }

  .prose :global(pre) {
    background: #1e1e1e;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    overflow-x: auto;
    margin: var(--space-xl) 0;
    line-height: 1.6;
    font-family: var(--font-mono);
  }

  .prose :global(pre::-webkit-scrollbar) {
    height: 8px;
  }

  .prose :global(pre::-webkit-scrollbar-track) {
    background: #2d2d2d;
    border-radius: 4px;
  }

  .prose :global(pre::-webkit-scrollbar-thumb) {
    background: #555;
    border-radius: 4px;
  }

  .prose :global(pre code) {
    background: none;
    padding: 0;
    color: #d4d4d4;
    font-size: 0.875rem;
  }

  .prose :global(blockquote) {
    border-left: 3px solid var(--accent-primary);
    padding-left: var(--space-lg);
    margin: var(--space-xl) 0;
    color: var(--text-secondary);
    font-style: italic;
    background: var(--bg-secondary);
    padding: var(--space-lg);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
  }

  .prose :global(blockquote p) {
    margin-bottom: 0;
  }

  .prose :global(img) {
    border-radius: var(--radius-lg);
    margin: var(--space-xl) 0;
    box-shadow: var(--shadow-md);
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--border-light);
    margin: var(--space-2xl) 0;
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-xl) 0;
    font-size: 0.9375rem;
  }

  .prose :global(th),
  .prose :global(td) {
    border: 1px solid var(--border-light);
    padding: var(--space-md);
    text-align: left;
  }

  .prose :global(th) {
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-weight: 600;
  }

  .prose :global(td) {
    color: var(--text-secondary);
  }

  /* Post Navigation */
  .post-navigation {
    margin-top: var(--space-3xl);
    padding-top: var(--space-2xl);
    border-top: 1px solid var(--border-light);
  }

  .nav-heading {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-tertiary);
    margin-bottom: var(--space-lg);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .nav-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
  }

  .nav-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    transition: all var(--transition-slow);
  }

  .nav-card:hover {
    border-color: var(--border-medium);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .nav-card.next {
    text-align: right;
    grid-column: 2;
  }

  .nav-card:only-child {
    grid-column: span 1;
  }

  .nav-card.next:only-child {
    grid-column: 2;
  }

  .nav-direction {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: color var(--transition-fast);
  }

  .nav-card.next .nav-direction {
    justify-content: flex-end;
  }

  .nav-card:hover .nav-direction {
    color: var(--accent-primary);
  }

  .nav-title {
    font-family: var(--font-display);
    font-size: 1.0625rem;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .nav-card svg {
    transition: transform var(--transition-fast);
  }

  .nav-card.prev:hover svg {
    transform: translateX(-3px);
  }

  .nav-card.next:hover svg {
    transform: translateX(3px);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .app-container {
      flex-direction: column;
    }

    .main-content {
      margin-left: 0;
      padding: var(--space-lg) var(--space-md);
      padding-bottom: var(--space-4xl);
    }

    .post-article {
      padding: var(--space-xl);
      border-radius: var(--radius-xl);
    }

    .post-title {
      font-size: 1.625rem;
    }

    .post-description {
      font-size: 1rem;
    }

    .post-meta {
      font-size: 0.8125rem;
    }

    .post-image {
      margin: var(--space-xl) calc(var(--space-md) * -1);
    }

    .nav-grid {
      grid-template-columns: 1fr;
    }

    .nav-card.next {
      grid-column: 1;
      text-align: left;
    }

    .nav-card.next .nav-direction {
      justify-content: flex-start;
    }

    .prose :global(p) {
      font-size: 1rem;
    }
  }
</style>
