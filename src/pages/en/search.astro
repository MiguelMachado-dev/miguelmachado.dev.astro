---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Sidebar from "../../components/Sidebar.astro";
import BottomNav from "../../components/BottomNav.astro";
import { ogImageServiceUrl } from "../../config/constants";
import { getTranslations } from "../../i18n";

const lang = "en";
const t = getTranslations(lang);

const searchUrl = new URL("/en/search", Astro.site || "https://miguelmachado.dev")
  .href;
const searchOgImage = `${ogImageServiceUrl}?title=${encodeURIComponent(t.search.title)}&url=${searchUrl}`;
---

<BaseLayout
  title={t.search.title}
  description={t.search.description}
  ogImage={searchOgImage}
  canonical={searchUrl}
  lang={lang}
>
  <div class="app-container" data-pagefind-ignore="all">
    <Sidebar />

    <main class="main-content">
      <div class="content-wrapper">
        <div class="search-container">
          <header class="search-header">
            <span class="header-eyebrow">Search</span>
            <h1 class="search-title">{t.search.title}</h1>
            <p class="search-description">Find articles about development, architecture, and best practices.</p>
          </header>
          <div id="search"></div>
        </div>
      </div>

      <BottomNav activePage="search" />
    </main>
  </div>

  <link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
  <script is:inline src="/pagefind/pagefind-ui.js"></script>

  <script>
    // @ts-expect-error - Pagefind UI is loaded via script tag
    import { PagefindUI } from "@pagefind/default-ui";

    function initializeSearch() {
      const searchElement = document.querySelector("#search");
      if (!searchElement) return;

      searchElement.innerHTML = "";

      new PagefindUI({
        element: "#search",
        showSubResults: true,
        autofocus: true,
      });

      const el = document.querySelector(".pagefind-ui");
      const input = el?.querySelector<HTMLInputElement>(`input[type="text"]`);
      const clearButton = el?.querySelector(".pagefind-ui__search-clear");

      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      const query = params.get("q");

      if (query && input) {
        input.value = query;
        input.dispatchEvent(new Event("input", { bubbles: true }));
      }

      input?.addEventListener("input", (e) => {
        const input = e.target as HTMLInputElement;
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        params.set("q", input.value);
        window.history.replaceState({}, "", `${url.pathname}?${params}`);
      });

      clearButton?.addEventListener("click", () => {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        params.delete("q");
        window.history.replaceState({}, "", `${url.pathname}`);
      });
    }

    document.addEventListener("DOMContentLoaded", initializeSearch);
    document.addEventListener("astro:page-load", initializeSearch);
  </script>
</BaseLayout>

<style>
  .app-container {
    display: flex;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: var(--space-3xl) var(--space-2xl);
    padding-bottom: var(--space-4xl);
    background: var(--bg-primary);
  }

  .content-wrapper {
    max-width: var(--page-max-width);
    margin: 0 auto;
    width: 100%;
  }

  .search-container {
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-2xl);
    padding: var(--space-2xl);
    box-shadow: var(--shadow-card);
  }

  .search-header {
    margin-bottom: var(--space-2xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--border-light);
  }

  .header-eyebrow {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--accent-primary);
    margin-bottom: var(--space-md);
    position: relative;
    padding-left: var(--space-lg);
  }

  .header-eyebrow::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 2px;
    background: var(--accent-primary);
  }

  .search-title {
    font-family: var(--font-display);
    font-size: clamp(1.5rem, 3vw, 2rem);
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    letter-spacing: -0.02em;
  }

  .search-description {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  /* Pagefind UI Customization */
  :global(.pagefind-ui) {
    width: 100% !important;
  }

  :global(.pagefind-ui__form) {
    position: relative !important;
    display: block !important;
  }

  :global(.pagefind-ui__form:before) {
    display: none !important;
  }

  :global(.pagefind-ui__search-input) {
    background-color: var(--bg-secondary) !important;
    border: 1px solid var(--border-light) !important;
    border-radius: var(--radius-lg) !important;
    color: var(--text-primary) !important;
    padding: var(--space-md) var(--space-3xl) var(--space-md) var(--space-lg) !important;
    font-size: 1rem !important;
    font-family: var(--font-body) !important;
    width: 100% !important;
    transition: all var(--transition-fast) !important;
  }

  :global(.pagefind-ui__search-input:focus) {
    border-color: var(--accent-primary) !important;
    outline: none !important;
    box-shadow: 0 0 0 3px var(--accent-primary-light) !important;
  }

  :global(.pagefind-ui__search-input::placeholder) {
    color: var(--text-muted) !important;
  }

  :global(.pagefind-ui__search-clear) {
    all: initial !important;
    font-family: var(--font-body) !important;
    position: absolute !important;
    right: var(--space-md) !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    background: var(--bg-tertiary) !important;
    color: var(--text-tertiary) !important;
    border: 1px solid var(--border-light) !important;
    border-radius: var(--radius-md) !important;
    padding: var(--space-xs) var(--space-sm) !important;
    font-size: 0.75rem !important;
    cursor: pointer !important;
    transition: all var(--transition-fast) !important;
    z-index: 10 !important;
  }

  :global(.pagefind-ui__search-clear:hover) {
    background: var(--accent-primary) !important;
    color: white !important;
    border-color: var(--accent-primary) !important;
  }

  :global(.pagefind-ui__drawer) {
    display: flex !important;
    flex-direction: column !important;
    gap: 0 !important;
    margin-top: var(--space-xl) !important;
    width: 100% !important;
  }

  :global(.pagefind-ui__results-area) {
    margin-top: 0 !important;
    width: 100% !important;
  }

  :global(.pagefind-ui__result) {
    background-color: var(--bg-secondary) !important;
    border: 1px solid var(--border-light) !important;
    border-radius: var(--radius-lg) !important;
    padding: var(--space-lg) !important;
    margin-bottom: var(--space-md) !important;
    overflow: hidden !important;
    transition: all var(--transition-fast) !important;
    list-style: none !important;
    width: 100% !important;
  }

  :global(.pagefind-ui__result:hover) {
    border-color: var(--accent-primary) !important;
    transform: translateY(-2px) !important;
    box-shadow: var(--shadow-md) !important;
  }

  :global(.pagefind-ui__result-thumb) {
    display: none !important;
  }

  :global(.pagefind-ui__result-inner) {
    padding: 0 !important;
    width: 100% !important;
  }

  :global(.pagefind-ui__result-inner > .pagefind-ui__result-title) {
    color: var(--text-primary) !important;
    font-family: var(--font-display) !important;
    font-weight: 500 !important;
    font-size: 1.125rem !important;
    line-height: 1.4 !important;
    margin-bottom: var(--space-sm) !important;
  }

  :global(.pagefind-ui__result-link) {
    text-decoration: none !important;
    color: var(--text-primary) !important;
    transition: color var(--transition-fast) !important;
  }

  :global(.pagefind-ui__result-link:hover) {
    color: var(--accent-primary) !important;
  }

  :global(.pagefind-ui__result-excerpt) {
    color: var(--text-secondary) !important;
    margin-top: var(--space-sm) !important;
    line-height: 1.6 !important;
    font-size: 0.875rem !important;
  }

  :global(.pagefind-ui__result-nested) {
    margin-top: var(--space-md) !important;
    padding-top: var(--space-md) !important;
    border-top: 1px solid var(--border-light) !important;
  }

  :global(.pagefind-ui__result-nested .pagefind-ui__result-title) {
    font-size: 0.9375rem !important;
    font-weight: 500 !important;
    color: var(--text-secondary) !important;
  }

  :global(.pagefind-ui__message) {
    color: var(--text-secondary) !important;
    padding: var(--space-lg) !important;
    text-align: center !important;
    font-size: 0.9375rem !important;
  }

  :global(.pagefind-ui__results) {
    list-style: none !important;
    padding: 0 !important;
    margin: 0 !important;
  }

  :global(.pagefind-ui__result-excerpt mark),
  :global(.pagefind-ui__result-title mark) {
    background-color: var(--accent-primary-light) !important;
    color: var(--accent-primary) !important;
    padding: 0.1rem 0.25rem !important;
    border-radius: var(--radius-sm) !important;
    font-weight: 600 !important;
  }

  :global(.pagefind-ui__button) {
    all: unset !important;
    display: inline-block !important;
    background: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-light) !important;
    border-radius: var(--radius-lg) !important;
    padding: var(--space-md) var(--space-xl) !important;
    cursor: pointer !important;
    transition: all var(--transition-fast) !important;
    font-size: 0.875rem !important;
    font-weight: 500 !important;
    font-family: var(--font-body) !important;
    text-align: center !important;
    margin: var(--space-md) auto !important;
  }

  :global(.pagefind-ui__button:hover) {
    background: var(--accent-primary) !important;
    border-color: var(--accent-primary) !important;
    color: white !important;
  }

  @media (max-width: 768px) {
    .app-container {
      flex-direction: column;
    }

    .main-content {
      margin-left: 0;
      padding: var(--space-xl) var(--space-md);
      padding-bottom: var(--space-4xl);
    }

    .search-container {
      padding: var(--space-lg);
      border-radius: var(--radius-xl);
    }

    .search-title {
      font-size: 1.375rem;
    }

    :global(.pagefind-ui__search-input) {
      padding: var(--space-md) var(--space-2xl) var(--space-md) var(--space-md) !important;
    }
  }
</style>
